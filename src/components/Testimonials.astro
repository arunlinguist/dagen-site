---
import testimonials from '../content/data/testimonials'

// Truncation helpers
const MAX_CHARS = 260
function truncateAtWord(text: string, limit = MAX_CHARS) {
  if (!text || typeof text !== 'string')
    return { short: text, truncated: false }
  if (text.length <= limit) return { short: text, truncated: false }
  let slice = text.slice(0, limit)
  const lastSpace = slice.lastIndexOf(' ')
  if (lastSpace > 0) {
    slice = slice.slice(0, lastSpace)
  }
  return { short: slice + 'â€¦', truncated: true }
}

const items = testimonials.map(t => {
  const { short, truncated } = truncateAtWord(t.feedback, MAX_CHARS)
  return { ...t, shortFeedback: short, truncated }
})
---

<section class='py-16 px-4'>
  <div class='max-w-7xl mx-auto'>
    <h2 class='text-3xl font-semibold text-slate-700 text-center mb-12'>
      Testimonials
    </h2>
    <div class='relative'>
      <button
        id='testimonial-scroll-left'
        class='absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white rounded-full p-3 shadow-lg hover:shadow-xl transition-shadow duration-300 opacity-0 pointer-events-none'
        aria-label='Scroll left'
        type='button'>
        <svg class='w-6 h-6 text-slate-700' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
          <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7' />
        </svg>
      </button>
      <div
        id='testimonials-container'
        class='flex gap-8 overflow-x-auto scroll-smooth scrollbar-hide pb-4 px-12'
        style='scrollbar-width: none; -ms-overflow-style: none;'>
        {
          items.map((testimonial, idx) => (
            <div class='bg-white p-6 shadow hover:shadow-lg transition-shadow duration-300 shrink-0 w-full sm:w-96' data-aos="fade" data-aos-duration="1000">
              <div class='flex items-center mb-4'>
                <img
                  src={testimonial.image}
                  alt={testimonial.name}
                  class='w-16 h-16 rounded-full mr-4 object-cover'
                />
                <div>
                  <h3 class='text-xl font-semibold text-slate-700'>
                    {testimonial.name}
                  </h3>
                  <p class='text-xs text-slate-500'>{testimonial.role}</p>
                </div>
              </div>
              <div class='text-slate-600 italic relative'>
                <div
                  id={`short-${idx}`}
                  class='testimonial-short transition-all duration-300 ease-in-out'>
                  <span class='block'>" {testimonial.shortFeedback} "</span>
                </div>
                <div
                  id={`full-${idx}`}
                  class='testimonial-full overflow-hidden transition-all duration-300 ease-in-out hidden'
                  style='max-height:0'>
                  <span class='block opacity-0 transition-opacity duration-300'>
                    " {testimonial.feedback} "
                  </span>
                </div>
              </div>
              {testimonial.truncated && (
                <button
                  class='mt-3 text-sky-700 text-sm font-medium hover:underline focus:outline-none'
                  data-idx={idx}
                  aria-expanded='false'
                  aria-controls={`short-${idx} full-${idx}`}
                  type='button'>
                  Read more
                </button>
              )}
            </div>
          ))
        }
      </div>
      <button
        id='testimonial-scroll-right'
        class='absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white rounded-full p-3 shadow-lg hover:shadow-xl transition-shadow duration-300'
        aria-label='Scroll right'
        type='button'>
        <svg class='w-6 h-6 text-slate-700' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
          <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5l7 7-7 7' />
        </svg>
      </button>
    </div>
  </div>
</section>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('button[data-idx]')
    const container = document.getElementById('testimonials-container')
    const scrollLeftBtn = document.getElementById('testimonial-scroll-left')
    const scrollRightBtn = document.getElementById('testimonial-scroll-right')

    // Scroll functionality
    function updateScrollButtons() {
      if (!container || !scrollLeftBtn || !scrollRightBtn) return
      
      const { scrollLeft, scrollWidth, clientWidth } = container
      const isAtStart = scrollLeft === 0
      const isAtEnd = scrollLeft + clientWidth >= scrollWidth - 1

      scrollLeftBtn.style.opacity = isAtStart ? '0' : '1'
      scrollLeftBtn.style.pointerEvents = isAtStart ? 'none' : 'auto'
      
      scrollRightBtn.style.opacity = isAtEnd ? '0' : '1'
      scrollRightBtn.style.pointerEvents = isAtEnd ? 'none' : 'auto'
    }

    if (scrollLeftBtn && container) {
      scrollLeftBtn.addEventListener('click', () => {
        container.scrollBy({ left: -400, behavior: 'smooth' })
      })
    }

    if (scrollRightBtn && container) {
      scrollRightBtn.addEventListener('click', () => {
        container.scrollBy({ left: 400, behavior: 'smooth' })
      })
    }

    if (container) {
      container.addEventListener('scroll', updateScrollButtons)
      updateScrollButtons() // Initial check
    }

    // Initialize all testimonial text to display properly
    document.querySelectorAll('.testimonial-short').forEach(wrap => {
      const span = wrap.querySelector('span')
      if (span) {
        // Allow text to flow naturally without height constraints
        wrap.style.maxHeight = 'none'
        wrap.style.overflow = 'visible'
      }
    })
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = btn.getAttribute('data-idx')
        const shortWrap = document.getElementById(`short-${idx}`)
        const fullWrap = document.getElementById(`full-${idx}`)
        if (!shortWrap || !fullWrap) return
        const expanded = btn.getAttribute('aria-expanded') === 'true'

        const fullSpan = fullWrap.querySelector('span')
        const shortSpan = shortWrap.querySelector('span')

        if (expanded) {
          // Collapse to short without over/undershooting
          // 1) Calculate target short height
          const sSpan = shortWrap.querySelector('span')
          const shortH = sSpan ? sSpan.scrollHeight : 0
          // 2) Temporarily overlay short content (absolute) so it doesn't affect layout
          shortWrap.classList.remove('hidden')
          shortWrap.style.position = 'absolute'
          shortWrap.style.left = '0'
          shortWrap.style.right = '0'
          shortWrap.style.maxHeight = shortH + 'px'
          shortWrap.style.overflow = 'hidden'
          if (sSpan) sSpan.classList.remove('opacity-0')
          // 3) Fade out full text and animate full wrap to short height
          fullSpan && fullSpan.classList.add('opacity-0')
          requestAnimationFrame(() => {
            fullWrap.style.maxHeight = shortH + 'px'
          })
          // 4) After animation, hide full and clean up short positioning
          setTimeout(() => {
            fullWrap.classList.add('hidden')
            fullWrap.style.maxHeight = '0'
            shortWrap.style.position = ''
            shortWrap.style.left = ''
            shortWrap.style.right = ''
            shortWrap.style.maxHeight = 'none'
            shortWrap.style.overflow = 'visible'
            btn.setAttribute('aria-expanded', 'false')
            btn.textContent = 'Read more'
          }, 300)
        } else {
          shortWrap.style.position = 'absolute'
          shortWrap.style.left = '0'
          shortWrap.style.right = '0'
          shortWrap.style.overflow = 'hidden'
          fullWrap.classList.remove('hidden')
          const shortH = shortSpan ? shortSpan.scrollHeight : 0
          const fullH = fullSpan ? fullSpan.scrollHeight : 0
          fullWrap.style.maxHeight = shortH + 'px'
          fullWrap.style.overflow = 'hidden'
          shortSpan && shortSpan.classList.add('opacity-0')
          requestAnimationFrame(() => {
            fullWrap.style.maxHeight = fullH + 'px'
            fullSpan && fullSpan.classList.remove('opacity-0')
          })
         
          setTimeout(() => {
            shortWrap.classList.add('hidden')
            shortWrap.style.position = ''
            shortWrap.style.left = ''
            shortWrap.style.right = ''
            btn.setAttribute('aria-expanded', 'true')
            btn.textContent = 'Show less'
          }, 300)
        }
      })
    })
  })
</script>

<style>
  #testimonials-container::-webkit-scrollbar {
    display: none;
  }
  
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
